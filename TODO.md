# Task: Build Real-Time Collaboration Web Application

## Plan
- [x] Step 1: Read key configuration files
  - [x] Read index.css for design tokens
  - [x] Read tailwind.config.js for theme configuration
  - [x] Read AuthContext.tsx for auth patterns
- [x] Step 2: Initialize Supabase and create database schema
  - [x] Initialize Supabase project
  - [x] Create profiles table with role enum
  - [x] Create documents table
  - [x] Create document_content table
  - [x] Create collaborators table with role enum
  - [x] Create document_versions table
  - [x] Create comments table
  - [x] Create active_users table for presence
  - [x] Set up RLS policies
  - [x] Create helper functions
  - [x] Set up auth trigger for profile sync
- [x] Step 3: Update design system
  - [x] Update index.css with collaboration app theme
  - [x] Ensure proper color tokens for light/dark mode
- [x] Step 4: Create types and database API
  - [x] Define TypeScript types matching database schema
  - [x] Create @/db/api.ts with all database operations
- [x] Step 5: Update auth system
  - [x] Update AuthContext.tsx for login/logout
  - [x] Update RouteGuard.tsx for route protection
  - [x] Update App.tsx with auth providers
- [x] Step 6: Create layout components
  - [x] Create AppLayout with sidebar navigation
- [x] Step 7: Create core pages
  - [x] Create Login page
  - [x] Create Dashboard page (document list)
  - [x] Create Editor page (main collaboration interface)
  - [x] Create Admin page (user management)
  - [x] Create Profile page
  - [x] Update routes.tsx
- [x] Step 8: Create editor components
  - [x] Create RichTextEditor component
  - [x] Create CollaboratorsSidebar component
  - [x] Create CommentsPanel component
  - [x] Create PresenceIndicator component
- [x] Step 9: Create document management components
  - [x] Create VersionHistoryDialog component
- [x] Step 10: Run lint and fix issues
  - [x] Fixed all TypeScript errors
  - [x] All lint checks passed
- [x] Step 11: Implement shareable invitation links
  - [x] Create document_invitations table
  - [x] Add invitation types to types.ts
  - [x] Create invitation API functions
  - [x] Create ShareDialog component
  - [x] Create InvitationPage component
  - [x] Update EditorPage with Share button
  - [x] Add invitation route
  - [x] Update RouteGuard for public invitation access
  - [x] Run lint and fix all issues
- [x] Step 12: Enhance rich text editor with advanced formatting
  - [x] Add font family selector (10 fonts)
  - [x] Add font size selector (10 sizes)
  - [x] Add text color picker (30 colors)
  - [x] Add text alignment buttons (left, center, right, justify)
  - [x] Add pre-made text layouts (8 templates)
  - [x] Update EditorContent type with new attributes
  - [x] Run lint and fix all issues
- [x] Step 13: Convert to Windows desktop application
  - [x] Install Electron and electron-builder dependencies
  - [x] Create Electron main process (electron/main.js)
  - [x] Create Electron preload script (electron/preload.js)
  - [x] Configure electron-builder (electron-builder.json)
  - [x] Update package.json with Electron scripts
  - [x] Update vite.config.ts for Electron compatibility
  - [x] Create application icon (build/icon.svg)
  - [x] Create LICENSE.txt for installer
  - [x] Create BUILD_GUIDE.md documentation
  - [x] Create QUICK_START.md guide
  - [x] Create README_DESKTOP.md
  - [x] Create ELECTRON_CONVERSION.md technical summary
  - [x] Run lint and verify all changes
- [x] Step 14: Add distinct editor textbox styling
  - [x] Update RichTextEditor with cream/golden theme for light mode
  - [x] Update RichTextEditor with dark/bronze theme for dark mode
  - [x] Add 2px border with rounded corners
  - [x] Add generous padding and minimum height
  - [x] Create EDITOR_VISUAL_DESIGN.md documentation
  - [x] Run lint and verify changes
- [x] Step 15: Add document export functionality
  - [x] Install file-saver and html-docx-js-typescript libraries
  - [x] Create exportUtils.ts with export functions
  - [x] Add exportAsText function for .txt export
  - [x] Add exportAsDocx function for .docx export
  - [x] Add filename sanitization and generation
  - [x] Update EditorPage with Export dropdown button
  - [x] Add export handlers with error handling
  - [x] Add toast notifications for export success/failure
  - [x] Create EXPORT_FEATURE.md documentation
  - [x] Run lint and verify all changes
- [x] Step 16: Fix React useState error
  - [x] Add explicit React import in AuthContext.tsx
  - [x] Update vite.config.ts with react/jsx-runtime dedupe
  - [x] Add optimizeDeps configuration to Vite
  - [x] Clear Vite cache to remove stale modules
  - [x] Create REACT_ERROR_FIX.md documentation
  - [x] Run lint and verify fix
- [x] Step 17: Add manual save functionality
  - [x] Add currentContent state to track editor content
  - [x] Add hasUnsavedChanges state to track save status
  - [x] Update handleContentChange to track unsaved changes
  - [x] Implement handleManualSave function with error handling
  - [x] Add Save button to toolbar with conditional styling
  - [x] Add status indicators (Saving, Unsaved changes, All saved)
  - [x] Implement keyboard shortcut (Ctrl+S / Cmd+S)
  - [x] Enhance auto-save with toast notifications
  - [x] Increase auto-save delay to 2 seconds
  - [x] Create MANUAL_SAVE_FEATURE.md documentation
  - [x] Run lint and verify all changes
- [x] Step 18: Fix HMR initialization error
  - [x] Clear Vite cache to remove stale modules
  - [x] Verify code structure is correct
  - [x] Create HMR_ERROR_FIX.md documentation
  - [x] Run lint and verify fix
- [x] Step 19: Add code collaboration feature
  - [x] Install Monaco Editor (@monaco-editor/react, monaco-editor)
  - [x] Create database schema for code documents
  - [x] Add code_documents, code_content, code_collaborators tables
  - [x] Add code_comments, code_versions, code_active_users tables
  - [x] Apply database migration with RLS policies
  - [x] Add code collaboration types to types.ts
  - [x] Create API functions for code collaboration in api.ts
  - [x] Create CodeDashboardPage with language selection
  - [x] Create CodeEditorPage with Monaco Editor
  - [x] Add routes for /codes and /code/:codeDocumentId
  - [x] Update AppLayout sidebar with "My Codes" button
  - [x] Implement auto-save and manual save for code
  - [x] Add presence tracking for code collaboration
  - [x] Add version control for code documents
  - [x] Create CODE_COLLABORATION_FEATURE.md documentation
  - [x] Run lint and verify all changes
- [x] Step 20: Fix browser cache error for PresenceIndicator
  - [x] Verify export pattern is correct (named export)
  - [x] Verify import statements are correct (named import)
  - [x] Clear Vite cache to remove stale modules
  - [x] Create BROWSER_CACHE_ERROR_FIX.md documentation
  - [x] Run lint and verify code is correct
- [x] Step 21: Fix code document creation error
  - [x] Add profile verification before document creation
  - [x] Create owner as collaborator automatically
  - [x] Add detailed error logging with error codes
  - [x] Make content creation non-blocking
  - [x] Add on-demand content creation in editor
  - [x] Create CODE_DOCUMENT_CREATION_FIX.md documentation
  - [x] Run lint and verify all changes
- [x] Step 22: Enhanced error reporting for code document creation
  - [x] Add try-catch error handling with throw statements
  - [x] Add session verification logging
  - [x] Add detailed console logs for debugging
  - [x] Update UI to display actual error messages
  - [x] Create CODE_CREATION_DEBUG_GUIDE.md documentation
  - [x] Run lint and verify all changes
- [x] Step 23: Fix infinite recursion in code_documents RLS policies
  - [x] Identify circular dependency between code_documents and code_collaborators
  - [x] Create security definer function user_has_code_document_access
  - [x] Update code_documents SELECT policy to use function
  - [x] Simplify code_collaborators policies
  - [x] Apply migrations to fix policies
  - [x] Verify no infinite recursion error
  - [x] Create INFINITE_RECURSION_FIX.md documentation
- [x] Step 24: Fix ambiguous user_id column reference in code_collaborators policies
  - [x] Identify ambiguous column reference error in SELECT policy
  - [x] Add explicit table qualifiers to all column references
  - [x] Update all code_collaborators policies (SELECT, INSERT, UPDATE, DELETE)
  - [x] Apply migration fix_collaborators_policy_explicit_table_names
  - [x] Verify policies work without ambiguity error

## Notes
- Using Supabase for backend (database + auth + real-time)
- Implementing polling for real-time updates (3-second intervals)
- Rich text editor built with contentEditable and custom formatting
- Role-based access: Owner, Editor, Viewer
- First registered user becomes admin
- Google OAuth uses SSO method as per requirements
- Username + password login (simulated with @miaoda.com domain)
- Auto-save functionality with 1-second debounce
- Version snapshots created every 10 edits
- Presence tracking updates every 5 seconds
- Active users shown with colored avatars
- Comments support threading and resolution
- Responsive design with resizable panels

## Shareable Invitation Links Feature
- Document owners can generate shareable invitation links
- Each link has configurable:
  - Access role (Editor or Viewer)
  - Expiration date (in days)
  - Maximum number of uses (optional)
- Links can be copied and shared with anyone
- Recipients can view invitation details before accepting
- Accept/Decline options for recipients
- Non-logged-in users are redirected to login, then back to invitation
- Invitation links are tracked and can be deleted by owner
- Active invitations displayed in ShareDialog with usage statistics

## Enhanced Rich Text Editor Features
- **Font Families**: 10 professional fonts (Arial, Georgia, Times New Roman, Courier New, Verdana, Helvetica, Comic Sans, Impact, Tahoma, Trebuchet)
- **Font Sizes**: 10 size options from 12px to 48px
- **Text Colors**: 30 color palette with common colors and shades
- **Text Alignment**: Left, Center, Right, Justify alignment options
- **Pre-made Layouts**: 8 professional templates:
  - Title + Subtitle: Large heading with descriptive subtitle
  - Quote Block: Styled blockquote with left border
  - Callout Box: Blue info box for important messages
  - Two Columns: Side-by-side content layout
  - Highlighted Text: Yellow highlighted emphasis
  - Step-by-Step: Numbered steps with circular badges
  - Warning Box: Red warning message box
  - Success Box: Green success message box
- All formatting is saved and persisted in document content
- Toolbar organized in two rows for better accessibility
- Color picker with visual color grid
- Layout picker with preview thumbnails
- **Distinct Editor Area**: Cream/warm-toned textbox with golden border in light mode, dark textbox with bronze border in dark mode for clear visual distinction

## Desktop Application (Electron)
- **Cross-Platform**: Windows, macOS, Linux support
- **Native Integration**: Application menu, keyboard shortcuts, window management
- **Build Options**: 
  - Windows Installer (.exe) - Full installation with shortcuts
  - Windows Portable (.exe) - No installation required
  - macOS DMG - Drag-and-drop installation
  - Linux AppImage - Universal package
  - Linux DEB - Debian/Ubuntu package
- **Security**: Context isolation, disabled node integration, secure IPC
- **Build Commands**:
  - `pnpm run electron:dev` - Development mode with hot reload
  - `pnpm run electron:build` - Build Windows installer
  - `pnpm run electron:build:portable` - Build portable version
  - `pnpm run electron:build:all` - Build for all platforms
- **Output Location**: `release/` directory
- **File Size**: ~150-200 MB per platform
- **Documentation**: BUILD_GUIDE.md, QUICK_START.md, README_DESKTOP.md, ELECTRON_CONVERSION.md

## Document Export Feature
- **Export Formats**: Plain Text (.txt) and Microsoft Word (.docx)
- **Text Export**: Extracts plain text from HTML, removes all formatting, preserves line breaks
- **Word Export**: Converts HTML to DOCX format, preserves formatting (fonts, colors, headings, lists, blockquotes, code blocks)
- **Filename Convention**: `DocumentTitle_YYYY-MM-DD_HH-MM.ext` with automatic sanitization
- **Browser Compatibility**: Works in all modern browsers (Chrome, Firefox, Safari, Edge)
- **Client-Side Processing**: All export processing happens in browser, no server upload required
- **Libraries Used**: file-saver for download triggering, html-docx-js-typescript for DOCX conversion
- **Export Button**: Located in editor toolbar as dropdown menu with two options
- **Error Handling**: Toast notifications for success/failure, validates content before export
- **Documentation**: EXPORT_FEATURE.md with complete usage guide and troubleshooting

## Manual Save Feature
- **Auto-Save**: Automatically saves changes after 2 seconds of inactivity with debouncing
- **Manual Save Button**: Highlighted Save button in toolbar when there are unsaved changes
- **Keyboard Shortcut**: Ctrl+S (Windows/Linux) or Cmd+S (Mac) to save from anywhere
- **Status Indicators**: Three states - "Saving..." (gray + spinner), "Unsaved changes" (amber), "All changes saved" (green)
- **Visual Feedback**: Save button changes variant (default when unsaved, ghost when saved) and disables when no changes
- **Toast Notifications**: Success notification on save, error notification with retry prompt on failure
- **State Tracking**: Tracks currentContent and hasUnsavedChanges to manage save state accurately
- **Error Handling**: Graceful error handling with user-friendly messages and retry options
- **Version Snapshots**: Creates automatic version snapshot every 10 edits for history tracking
- **Documentation**: MANUAL_SAVE_FEATURE.md with complete feature guide and troubleshooting

## Code Collaboration Feature
- **Monaco Editor**: Professional code editor (same as VS Code) with syntax highlighting, IntelliSense, bracket colorization, minimap, and code folding
- **16 Programming Languages**: JavaScript, TypeScript, Python, Java, C++, C#, Go, Rust, PHP, Ruby, Swift, Kotlin, HTML, CSS, SQL, Shell
- **Real-Time Collaboration**: Multiple users can edit code simultaneously with live cursor tracking and presence indicators
- **Auto-Save**: Automatically saves code after 2 seconds of inactivity with debouncing and toast notifications
- **Manual Save**: Save button and Ctrl+S/Cmd+S keyboard shortcut with status indicators (Saving, Unsaved, Saved)
- **Version Control**: Automatic version snapshots every 10 edits, accessible via History button
- **Database Tables**: code_documents, code_content, code_collaborators, code_comments, code_versions, code_active_users
- **Sidebar Navigation**: Added "My Codes" button in sidebar between "My Documents" and "Admin"
- **Code Dashboard**: Grid view with language icons, create/delete operations, last updated timestamps
- **Code Editor**: Full-screen Monaco Editor with toolbar (Save, History, Comments, Share, Collaborators)
- **Presence Tracking**: Shows active users with color-coded avatars, updates every 5 seconds, removes inactive after 5 minutes
- **Theme Support**: Dark/Light theme support matching application theme from localStorage
- **Editor Features**: Font ligatures, format on paste/type, word wrap, line numbers, whitespace rendering, indentation guides
- **Security**: RLS policies for access control, role-based permissions (owner, editor, viewer)
- **API Functions**: Complete CRUD operations for documents, content, collaborators, comments, versions, and presence
- **Documentation**: CODE_COLLABORATION_FEATURE.md with complete usage guide, API reference, and troubleshooting

## Code Document Creation Fix
- **Profile Verification**: Added check to ensure user profile exists before creating code document, preventing foreign key constraint violations
- **Owner Collaborator Entry**: Automatically creates collaborator entry for owner when document is created, ensuring RLS policies allow content insertion
- **Detailed Error Logging**: Enhanced error logging with message, details, hint, and code for better debugging and troubleshooting
- **Non-Blocking Content Creation**: Document creation succeeds even if initial content creation fails, preventing total operation failure
- **On-Demand Content Creation**: Editor creates content automatically if it doesn't exist, handling edge cases gracefully
- **Error Handling**: Comprehensive error handling at each step (profile verification, document creation, collaborator creation, content creation)
- **RLS Policy Compliance**: Ensures all operations comply with Row Level Security policies by creating necessary entries in correct order
- **Transaction Ordering**: Creates parent records (document) before children (collaborator, content) to avoid race conditions
- **Graceful Degradation**: Continues operation even if non-critical steps fail, with detailed logging for debugging
- **Documentation**: CODE_DOCUMENT_CREATION_FIX.md with root cause analysis, changes made, testing steps, debugging guide, and prevention best practices

## Infinite Recursion Fix
- **Root Cause**: Circular dependency in RLS policies where code_documents SELECT policy checked code_collaborators, and code_collaborators policies checked code_documents, creating infinite recursion loop
- **Security Definer Function**: Created user_has_code_document_access function that runs with elevated privileges (SECURITY DEFINER) to check document access without triggering RLS policies
- **Function Logic**: Checks if user is owner (code_documents.owner_id = user_id) OR collaborator (exists in code_collaborators), returns boolean without causing recursion
- **Updated SELECT Policy**: Changed code_documents SELECT policy from subquery to function call: user_has_code_document_access(id, auth.uid())
- **Simplified Collaborator Policies**: Rewrote code_collaborators policies (SELECT, INSERT, UPDATE, DELETE) to avoid circular references while maintaining security
- **Migration Applied**: fix_code_documents_infinite_recursion and add_code_documents_access_function migrations successfully applied
- **Benefits**: Breaks circular dependency, maintains security, better performance than nested subqueries, supports collaboration feature, easier to maintain
- **Security**: Function is read-only, uses parameterized queries, no SQL injection risk, still enforces ownership and collaboration checks
- **Testing**: Verified no infinite recursion error when querying code_documents, policies work correctly for owners and collaborators
- **Documentation**: INFINITE_RECURSION_FIX.md with detailed explanation, implementation steps, testing procedures, security considerations, and troubleshooting guide

## Ambiguous Column Reference Fix
- **Root Cause**: SQL query in code_collaborators RLS policy referenced user_id without table qualifier, causing ambiguity when PostgreSQL couldn't determine which table's user_id column to use
- **Error Message**: "column reference 'user_id' is ambiguous" occurred during document creation when INSERT operation triggered SELECT policy to return inserted row
- **Explicit Table Qualifiers**: Added table name prefixes to all column references in code_collaborators policies (code_collaborators.user_id, code_collaborators.code_document_id, code_documents.id, code_documents.owner_id)
- **Updated All Policies**: Rewrote SELECT, INSERT, UPDATE, and DELETE policies for code_collaborators with fully qualified column names to eliminate ambiguity
- **Migration Applied**: fix_collaborators_policy_explicit_table_names migration successfully applied, dropping old policies and recreating with explicit table names
- **Benefits**: Eliminates ambiguity errors, improves query planner optimization, makes debugging easier, prevents future issues, maintains same security level
- **Best Practice**: Always use table qualifiers (table_name.column_name) especially with common column names (id, user_id, created_at) and in RLS policies with subqueries
- **Testing**: Verified policies work without ambiguity error by querying code_collaborators table, confirmed all four policies (SELECT, INSERT, UPDATE, DELETE) are correctly configured
- **Documentation**: AMBIGUOUS_COLUMN_FIX.md with problem explanation, solution implementation, before/after comparison, best practices, and testing procedures



